- name: Ensure config directory exists on nodes
  file:
    path: "{{ paths.kubernetes.config_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Distribute admin kubeconfig to masters
  copy:
    src: "{{ paths.artifacts.kubeconfigs }}/admin.kubeconfig"
    dest: "{{ paths.kubernetes.config_dir }}/admin.kubeconfig"
    mode: "0600"
    owner: root
    group: root
  when: inventory_hostname in groups['masters']
  retries: "{{ distribute_retries }}"
  delegate_to: localhost

- name: Distribute admin kubeconfig to jumpbox
  copy:
    src: "{{ paths.artifacts.kubeconfigs }}/admin.kubeconfig"
    dest: "{{ paths.kubernetes.config_dir }}/admin.kubeconfig"
    mode: "0600"
    owner: root
    group: root
  when: inventory_hostname == 'jumpbox'
  retries: "{{ distribute_retries }}"
  delegate_to: localhost

- name: Distribute kubelet kubeconfig to nodes
  copy:
    src: "{{ paths.artifacts.kubeconfigs }}/{{ inventory_hostname }}.kubeconfig"
    dest: "{{ paths.kubernetes.config_dir }}/kubelet.kubeconfig"
    mode: "0600"
    owner: root
    group: root
  when: inventory_hostname in groups['masters'] or inventory_hostname in groups['workers']
  retries: "{{ distribute_retries }}"
  delegate_to: localhost

- name: Distribute kube-proxy kubeconfig to workers
  copy:
    src: "{{ paths.artifacts.kubeconfigs }}/kube-proxy.kubeconfig"
    dest: "{{ paths.kubernetes.config_dir }}/kube-proxy.kubeconfig"
    mode: "0600"
    owner: root
    group: root
  when: inventory_hostname in groups['workers']
  retries: "{{ distribute_retries }}"
  delegate_to: localhost
